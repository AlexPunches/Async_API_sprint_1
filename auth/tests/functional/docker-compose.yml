version: '3'
services:
  test-redis:
    image: redis:7-alpine
    restart: unless-stopped
    expose:
      - "6379"
    ports:
      - "6379:6379"

  test-auth-postgres:
    image: postgres:14-alpine
    restart: unless-stopped
    volumes:
      - pg_data_auth_test:/var/lib/postgresql/data/
    expose:
      - "5432"
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: ${POSTGRES_DB_AUTH}
      POSTGRES_USER: ${POSTGRES_USER_AUTH}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD_AUTH}

  test-auth:
    build: ../../.
    image: auth-flask-image
    volumes:
      - /tmp/logs/auth_flask/:/var/log/auth_flask/
    expose:
      - "5000"
    environment:
      POSTGRES_DB_AUTH: ${POSTGRES_DB_AUTH}
      POSTGRES_USER_AUTH: ${POSTGRES_USER_AUTH}
      POSTGRES_PASSWORD_AUTH: ${POSTGRES_PASSWORD_AUTH}
      # Подключение к PostgresSQL внутри сети Docker Compose.
      DB_HOST_AUTH: 'test-auth-postgres'
      # Подключение к Redis внутри сети Docker Compose.
      REDIS_HOST: 'test-redis'
      # Настройки безопасности.
      ENABLE_TRACER: 'False'
      FLASK_SECRET_KEY: 'test_flask_security_key'
      JWT_SECRET_KEY: 'test_jwt_security_key'
      GOOGLE_OAUTH_CLIENT_ID: ''
      GOOGLE_OAUTH_CLIENT_SECRET: ''
    ports:
      - "5000:5000"
    depends_on:
      - test-auth-postgres
    entrypoint: >
      sh -c "python /opt/app/src/manage.py db upgrade head
      && gunicorn -b 0.0.0.0:5000 --workers 4 src.pywsgi:app"

  auth-pytests:
    image: auth-flask-image
    expose:
      - "5000"
    environment:
      AUTH_HOST: 'test-auth'
    depends_on:
      - test-redis
      - test-auth
    entrypoint: >
      sh -c "pip install -r /opt/app/tests/functional/requirements.txt
      && python3 /opt/app/tests/functional/utils/wait_for_redis.py
      && python /opt/app/src/manage.py db upgrade head
      && pytest /opt/app/tests/functional/src"

volumes:
  pg_data_auth_test:
